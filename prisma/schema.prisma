// FinPilot - Premium Financial OS Backend Schema
// Based on complete SOP with all agent architectures

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & PROFILE MODELS
// ============================================================================

model User {
  id                    String      @id @default(cuid())
  email                 String      @unique
  name                  String?
  phone                 String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  // Relations
  profile               Profile?
  accounts              Account[]
  transactions          Transaction[]
  jars                  Jar[]
  goals                 Goal[]
  incomeRecords         IncomeRecord[]
  alerts                Alert[]
  assets                Asset[]
  portfolioHoldings     PortfolioHolding[]
  smsRecords            SMSRecord[]
  spendingPatterns      SpendingPattern[]
  budgets               Budget[]
  
  @@index([email])
}

model Profile {
  id                    String      @id @default(cuid())
  userId                String      @unique
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Financial Profile
  monthlyIncome         Decimal     @db.Decimal(12, 2) @default(0)
  riskTolerance         String      @default("moderate")
  currency              String      @default("INR")
  timezone              String      @default("Asia/Calcutta")
  
  // Preferences
  preferredLanguage     String      @default("en")
  notificationsEnabled  Boolean     @default(true)
  voiceEnabled          Boolean     @default(true)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

// ============================================================================
// ACCOUNT & TRANSACTION MODELS
// ============================================================================

model Account {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountName           String
  accountType           String
  bankName              String?
  accountNumber         String?
  balance               Decimal     @db.Decimal(12, 2) @default(0)
  
  lastSMSParsed         DateTime?
  smsPhoneNumber        String?
  
  isActive              Boolean     @default(true)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  transactions          Transaction[]
  smsRecords            SMSRecord[]
  
  @@index([userId])
  @@index([accountType])
}

model Transaction {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String
  account               Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  amount                Decimal     @db.Decimal(12, 2)
  type                  String
  category              String
  merchant              String?
  description           String?
  
  transactionDate       DateTime
  isRecurring           Boolean     @default(false)
  frequency             String?
  
  parsedFromSMS         Boolean     @default(false)
  smsRecordId           String?     @unique
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  smsRecord             SMSRecord?  @relation(fields: [smsRecordId], references: [id])
  
  @@index([userId])
  @@index([accountId])
  @@index([category])
  @@index([transactionDate])
  @@index([type])
}

// ============================================================================
// JAR SYSTEM MODELS
// ============================================================================

model Jar {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  color                 String      @default("#3B82F6")
  icon                  String?
  
  targetAmount          Decimal     @db.Decimal(12, 2)
  currentAmount         Decimal     @db.Decimal(12, 2) @default(0)
  allocationPercentage  Decimal     @db.Decimal(5, 2) @default(0)
  
  priority              Int         @default(0)
  isEssential           Boolean     @default(false)
  autoAllocate          Boolean     @default(true)
  
  dueDate               DateTime?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  allocations           JarAllocation[]
  
  @@index([userId])
  @@index([priority])
}

model JarAllocation {
  id                    String      @id @default(cuid())
  jarId                 String
  jar                   Jar         @relation(fields: [jarId], references: [id], onDelete: Cascade)
  
  amount                Decimal     @db.Decimal(12, 2)
  allocationDate        DateTime    @default(now())
  reason                String?
  
  createdAt             DateTime    @default(now())
  
  @@index([jarId])
  @@index([allocationDate])
}

// ============================================================================
// INCOME & FORECASTING MODELS
// ============================================================================

model IncomeRecord {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  amount                Decimal     @db.Decimal(12, 2)
  source                String
  incomeDate            DateTime
  
  isRecurring           Boolean     @default(false)
  frequency             String?
  nextExpectedDate      DateTime?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([incomeDate])
}

model IncomeForecast {
  id                    String      @id @default(cuid())
  userId                String      @unique
  
  forecast7Day          Decimal     @db.Decimal(12, 2)
  forecast30Day         Decimal     @db.Decimal(12, 2)
  forecast90Day         Decimal     @db.Decimal(12, 2)
  
  confidence7Day        Int         @default(0)
  confidence30Day       Int         @default(0)
  confidence90Day       Int         @default(0)
  
  lower7Day             Decimal     @db.Decimal(12, 2)
  upper7Day             Decimal     @db.Decimal(12, 2)
  lower30Day            Decimal     @db.Decimal(12, 2)
  upper30Day            Decimal     @db.Decimal(12, 2)
  lower90Day            Decimal     @db.Decimal(12, 2)
  upper90Day            Decimal     @db.Decimal(12, 2)
  
  trend                 String      @default("stable")
  incomeDips            Boolean     @default(false)
  trendShifts           String?
  
  lastUpdated           DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
}

// ============================================================================
// CASHFLOW & RUNOUT MODELS
// ============================================================================

model CashflowAnalysis {
  id                    String      @id @default(cuid())
  userId                String      @unique
  
  safeToSpendToday      Decimal     @db.Decimal(12, 2)
  dailyBurnRate         Decimal     @db.Decimal(12, 2)
  
  runoutDays            Int
  runoutDate            DateTime?
  
  trend                 String      @default("stable")
  
  lastUpdated           DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
}

// ============================================================================
// GOAL PLANNING MODELS
// ============================================================================

model Goal {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  category              String
  
  targetAmount          Decimal     @db.Decimal(12, 2)
  currentAmount         Decimal     @db.Decimal(12, 2) @default(0)
  
  targetDate            DateTime
  startDate             DateTime    @default(now())
  
  status                String      @default("active")
  priority              Int         @default(0)
  
  isFeasible            Boolean     @default(true)
  monthlySavingsNeeded  Decimal     @db.Decimal(12, 2) @default(0)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  milestones            Milestone[]
  
  @@index([userId])
  @@index([status])
}

model Milestone {
  id                    String      @id @default(cuid())
  goalId                String
  goal                  Goal        @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  name                  String
  targetAmount          Decimal     @db.Decimal(12, 2)
  targetDate            DateTime
  
  isCompleted           Boolean     @default(false)
  completedDate         DateTime?
  
  createdAt             DateTime    @default(now())
  
  @@index([goalId])
}

// ============================================================================
// ALERT & NOTIFICATION MODELS
// ============================================================================

model Alert {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                  String
  severity              String      @default("medium")
  title                 String
  message               String
  
  relatedEntityId       String?
  relatedEntityType     String?
  
  actionUrl             String?
  actionLabel           String?
  
  isRead                Boolean     @default(false)
  isDismissed           Boolean     @default(false)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([type])
  @@index([severity])
  @@index([isRead])
}

model AlertRule {
  id                    String      @id @default(cuid())
  userId                String
  
  name                  String
  type                  String
  
  condition             String
  threshold             Decimal     @db.Decimal(12, 2)
  
  isActive              Boolean     @default(true)
  triggerCount          Int         @default(0)
  lastTriggered         DateTime?
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([type])
}

// ============================================================================
// ASSET & PORTFOLIO MODELS
// ============================================================================

model Asset {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                  String
  type                  String
  symbol                String?
  
  quantity              Decimal     @db.Decimal(18, 8)
  purchasePrice         Decimal     @db.Decimal(12, 2)
  currentPrice          Decimal     @db.Decimal(12, 2)
  
  totalValue            Decimal     @db.Decimal(12, 2)
  gainLoss              Decimal     @db.Decimal(12, 2)
  gainLossPercent       Decimal     @db.Decimal(5, 2)
  
  purchaseDate          DateTime
  lastPriceUpdate       DateTime    @default(now())
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  holdings              PortfolioHolding[]
  
  @@index([userId])
  @@index([type])
}

model PortfolioHolding {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  assetId               String
  asset                 Asset       @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  quantity              Decimal     @db.Decimal(18, 8)
  averageCost           Decimal     @db.Decimal(12, 2)
  currentValue          Decimal     @db.Decimal(12, 2)
  
  dayChange            Decimal     @db.Decimal(12, 2)
  dayChangePercent     Decimal     @db.Decimal(5, 2)
  weekChange           Decimal     @db.Decimal(12, 2)
  monthChange          Decimal     @db.Decimal(12, 2)
  
  allocationPercent    Decimal     @db.Decimal(5, 2)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([assetId])
}

model PortfolioForecast {
  id                    String      @id @default(cuid())
  userId                String      @unique
  
  forecast1Day          Decimal     @db.Decimal(12, 2)
  forecast7Day          Decimal     @db.Decimal(12, 2)
  forecast30Day         Decimal     @db.Decimal(12, 2)
  
  confidence1Day        Int         @default(0)
  confidence7Day        Int         @default(0)
  confidence30Day       Int         @default(0)
  
  lower1Day             Decimal     @db.Decimal(12, 2)
  upper1Day             Decimal     @db.Decimal(12, 2)
  lower7Day             Decimal     @db.Decimal(12, 2)
  upper7Day             Decimal     @db.Decimal(12, 2)
  lower30Day            Decimal     @db.Decimal(12, 2)
  upper30Day            Decimal     @db.Decimal(12, 2)
  
  volatilitySpike       Boolean     @default(false)
  riskZones             String?
  
  lastUpdated           DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
}

// ============================================================================
// SMS PARSING MODELS
// ============================================================================

model SMSRecord {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String
  account               Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  smsText               String
  sender                String?
  
  amount                Decimal     @db.Decimal(12, 2)
  merchant              String?
  transactionType       String?
  category              String?
  
  isParsed              Boolean     @default(false)
  parseConfidence       Int         @default(0)
  
  transaction           Transaction?
  
  receivedAt            DateTime    @default(now())
  createdAt             DateTime    @default(now())
  
  @@index([userId])
  @@index([accountId])
  @@index([isParsed])
}

// ============================================================================
// SPENDING PATTERN MODELS
// ============================================================================

model SpendingPattern {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category              String
  
  frequency             String
  averageAmount         Decimal     @db.Decimal(12, 2)
  
  peakDay               String?
  peakDayAmount         Decimal     @db.Decimal(12, 2)
  
  hasAnomalies          Boolean     @default(false)
  anomalyDescription    String?
  
  isRecurringSubscription Boolean   @default(false)
  subscriptionName      String?
  subscriptionCost      Decimal     @db.Decimal(12, 2)
  
  lastAnalyzed          DateTime    @default(now())
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([category])
}

// ============================================================================
// BUDGET MODELS
// ============================================================================

model Budget {
  id                    String      @id @default(cuid())
  userId                String
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  category              String
  monthlyLimit          Decimal     @db.Decimal(12, 2)
  currentSpent          Decimal     @db.Decimal(12, 2) @default(0)
  
  suggestedLimit        Decimal     @db.Decimal(12, 2)
  potentialSavings      Decimal     @db.Decimal(12, 2)
  optimizedDailyLimit   Decimal     @db.Decimal(12, 2)
  
  isActive              Boolean     @default(true)
  month                 Int
  year                  Int
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@unique([userId, category, month, year])
  @@index([userId])
  @@index([category])
}

// ============================================================================
// FINANCIAL INSIGHTS & COACHING
// ============================================================================

model FinancialInsight {
  id                    String      @id @default(cuid())
  userId                String
  
  type                  String
  title                 String
  description           String
  
  confidence            Int         @default(0)
  impactScore           Int         @default(0)
  
  suggestedActions      String?
  
  isRead                Boolean     @default(false)
  isActioned            Boolean     @default(false)
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([userId])
  @@index([type])
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id                    String      @id @default(cuid())
  userId                String
  
  action                String
  entityType            String
  entityId              String
  
  oldValues             String?
  newValues             String?
  
  createdAt             DateTime    @default(now())
  
  @@index([userId])
  @@index([entityType])
}
